# Go-TreeSitter Dependency Analyzer

ä¸€ä¸ªåŸºäº **Tree-sitter** çš„é«˜æ€§èƒ½ã€æ’ä»¶åŒ–å¤šè¯­è¨€æºç ä¾èµ–åˆ†æå¼•æ“ã€‚

è¯¥å·¥å…·æ—¨åœ¨é€šè¿‡ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰è§£æï¼Œè·¨è¶Šç‰©ç†æ–‡ä»¶è¾¹ç•Œï¼Œæ„å»ºå‡ºåŒ…å«**å±‚çº§ç»“æ„ï¼ˆContainmentï¼‰ä¸é€»è¾‘å¼•ç”¨ï¼ˆLogic Dependencyï¼‰çš„å®Œæ•´ä»£ç çŸ¥è¯†å›¾è°±ã€‚è™½ç„¶ç›®å‰ä»¥ Java ä¸ºé¦–ä¸ªæ·±åº¦æ”¯æŒçš„è¯­è¨€ï¼Œä½†å…¶æ ¸å¿ƒæ¡†æ¶è®¾è®¡ä¸ºè¯­è¨€æ— å…³**ã€‚

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨è§£è€¦çš„**ä¸‰é˜¶æ®µå¤„ç†æµæ°´çº¿**ï¼Œç¡®ä¿äº†åœ¨å¤æ‚ç¬¦å·è§£æä¸‹çš„é«˜æ€§èƒ½è¡¨ç°ï¼š

1. **Phase 1: ç¬¦å·æ”¶é›† (Collection)**ï¼šå¹¶å‘æ‰«ææ–‡ä»¶ï¼Œæå–ç±»ã€æ–¹æ³•ã€å˜é‡å®šä¹‰ï¼Œæ„å»ºå…¨å±€ç¬¦å·ç´¢å¼•ï¼ˆGlobal Contextï¼‰ã€‚
2. **Phase 2: å±‚æ¬¡è¡¥å…¨ (Stitching)**ï¼šæ ¹æ®åŒ…ååŠè·¯å¾„ï¼Œè‡ªåŠ¨ç»‡å…¥ `Package -> File -> Class` çš„ç‰©ç†ä¸é€»è¾‘å½’å±å…³ç³»ã€‚
3. **Phase 3: å…³ç³»æå– (Extraction)**ï¼šåŸºäº Tree-sitter Query æ•è·åŠ¨ä½œï¼ˆå¦‚ Call, Createï¼‰ï¼Œå¹¶åˆ©ç”¨**ç»§æ‰¿é“¾ç®—æ³•**è¿›è¡Œç²¾ç¡®çš„ç¬¦å·æ¶ˆæ­§ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ¨¡å—è¯´æ˜

| æ¨¡å— | è·¯å¾„ | èŒè´£ |
| --- | --- | --- |
| **Model** | `/model` | å®šä¹‰é€šç”¨çš„ä»£ç å…ƒç´ ã€ä½ç½®ä¿¡æ¯åŠå…³ç³»ç±»å‹ï¼ˆè¯­è¨€æ— å…³ï¼‰ã€‚ |
| **Parser** | `/parser` | å°è£… Tree-sitter è§£æé€»è¾‘ï¼Œæä¾› AST æ ¼å¼åŒ–è¾“å‡ºå·¥å…·ã€‚ |
| **Context** | `/context` | ç»´æŠ¤å…¨å±€ç¬¦å·è¡¨ï¼ˆSymbol Tableï¼‰ï¼Œæä¾›è·¨æ–‡ä»¶çš„ç¬¦å·æŸ¥æ‰¾èƒ½åŠ›ã€‚ |
| **Processor** | `/processor` | æ ¸å¿ƒè°ƒåº¦å¼•æ“ï¼Œè´Ÿè´£é©±åŠ¨ä¸‰é˜¶æ®µæµæ°´çº¿çš„å¹¶å‘æ‰§è¡Œã€‚ |
| **Language Extensions** | `/x` | è¯­è¨€ç‰¹å®šå®ç°ï¼ˆå¦‚ `/x/java`ï¼‰ï¼ŒåŒ…å«è¯¥è¯­è¨€çš„æ”¶é›†å™¨ã€æå–å™¨åŠè§£æè§„åˆ™ã€‚ |

---

## ğŸ“Š æ•°æ®æ¨¡å‹ (Data Model)

åˆ†æå™¨çš„è¾“å‡ºç”± **CodeElementï¼ˆèŠ‚ç‚¹ï¼‰** å’Œ **DependencyRelationï¼ˆè¾¹ï¼‰** ç»„æˆã€‚

### 1. CodeElement (ä»£ç å…ƒç´ )

```go
type CodeElement struct {
    Name          string       // å…ƒç´ åç§° (å¦‚: getUser)
    Kind          ElementKind  // ç±»å‹ (Class, Method, Field, etc.)
    QualifiedName string       // å…¨é™å®šå (å¦‚: com.auth.Service.getUser)
    Path          string       // ç›¸å¯¹æ–‡ä»¶è·¯å¾„
    Location      *Location    // è¡Œåˆ—ä½ç½®ä¿¡æ¯
    Signature     string       // åŸå§‹ä»£ç ç­¾å
}

```

### 2. DependencyRelation (ä¾èµ–å…³ç³»)

```go
type DependencyRelation struct {
    Type     RelationType // å…³ç³»ç±»å‹ (å¦‚ CALL, EXTEND)
    Source   *CodeElement // å‘èµ·æ–¹ (å¦‚ï¼šè°ƒç”¨è€…æ–¹æ³•)
    Target   *CodeElement // ç›®æ ‡æ–¹ (å¦‚ï¼šè¢«è°ƒç”¨çš„æ–¹æ³•)
    Location *Location    // å…³ç³»å‘ç”Ÿçš„ç²¾ç¡®æºç ä½ç½®
}

```

#### å…³ç³»åˆ†ç±»è¯¦è¿°

| åˆ†ç±» | ç±»å‹ | è¯­ä¹‰è¯´æ˜        | æ•æ‰åœºæ™¯ç¤ºä¾‹                                    |
| --- | - |-------------|-------------------------------------------|
| **ç»„ç»‡ç»“æ„** | **CONTAIN** | é€»è¾‘å±‚çº§åŒ…å«/æˆå‘˜å½’å± | åŒ…åŒ…å«ç±»ã€æ–‡ä»¶åŒ…å«ç±»ã€ç±»åŒ…å«æ–¹æ³•ã€ç±»åŒ…å«å­—æ®µ                    |
| **å®šä¹‰ä¾èµ–** | **EXTEND** | ç»§æ‰¿å…³ç³»        | ç±»ç»§æ‰¿ã€æ¥å£ç»§æ‰¿ï¼ˆæ”¯æŒè·¨æ–‡ä»¶è¿½è¸ªï¼‰                         |
|  | **IMPLEMENT** | å®ç°å…³ç³»        | ç±»å®ç°æ¥å£                                     |
|  | **PARAMETER** | å‚æ•°ä¾èµ–        | æ–¹æ³•ç­¾åä¸­çš„å…¥å‚ç±»å‹                                |
|  | **RETURN** | è¿”å›å€¼ä¾èµ–       | æ–¹æ³•ç­¾åä¸­çš„è¿”å›ç±»å‹                                |
|  | **ANNOTATION** | å…ƒæ•°æ®å¼•ç”¨       | ç±»æˆ–æ–¹æ³•ä¸Šæ ‡æ³¨çš„æ³¨è§£                                |
| **é€»è¾‘åŠ¨ä½œ** | **CALL** | æ–¹æ³•/å‡½æ•°è°ƒç”¨     | 1. `obj.save()` 2. `super()` è°ƒç”¨ 3. é™æ€å¯¼å…¥è°ƒç”¨ |
|  | **CREATE** | å®ä¾‹åŒ–         | `new UserService()` æ•è·                    |
|  | **USE** | æˆå‘˜è®¿é—®        | è®¿é—®å­—æ®µæˆ–é™æ€å¸¸é‡                                 |
|  | **CAST** | ç±»å‹å¼ºè½¬        | `(User) obj` ä¸­çš„ç±»å‹ä¾èµ–                       |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

æœ¬é¡¹ç›®ä¾èµ– [Tree-sitter](https://tree-sitter.github.io/tree-sitter/) çš„ C åº“ç»‘å®šï¼Œå› æ­¤åœ¨ç¼–è¯‘å’Œè¿è¡Œæ—¶éœ€è¦å¯ç”¨ CGOã€‚

### 1. ç¼–è¯‘ (Build)

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

```bash
# å¿…é¡»è®¾ç½® CGO_ENABLED=1
export CGO_ENABLED=1
go build -o deps-analyzer main.go

```

### 2. åŸºç¡€ä½¿ç”¨ (Usage)

ç¼–è¯‘å®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šåˆ†æç›®æ ‡ã€‚

#### å¯¼å‡ºåˆ†ææ•°æ® (JSONL)

é»˜è®¤æƒ…å†µä¸‹ï¼Œå·¥å…·ä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š`element.jsonl`ï¼ˆåŒ…å«æ‰€æœ‰å®šä¹‰çš„ç¬¦å·ï¼‰å’Œ `relation.jsonl`ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–å…³ç³»ï¼‰ã€‚

```bash
./deps-analyzer -lang java -path /your/project/src -out-dir ./output

```

#### ç”Ÿæˆå¯è§†åŒ–å›¾è°± (Mermaid)

å¦‚æœä½ æƒ³ç›´æ¥æŸ¥çœ‹ä»£ç ç»“æ„å›¾ï¼Œå¯ä»¥ä½¿ç”¨ `-format mermaid` å‚æ•°ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€çš„ `visualization.html`ã€‚

```bash
./deps-analyzer -lang java -path /your/project/src -format mermaid

```

### 3. å‘½ä»¤è¡Œå‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
| --- | --- | --- |
| `-lang` | `java` | æŒ‡å®šåˆ†æçš„è¯­è¨€ï¼ˆç›®å‰æ”¯æŒ `java`ï¼Œ`go` å¼€å‘ä¸­ï¼‰ |
| `-path` | `.` | å¾…åˆ†æçš„æºä»£ç é¡¹ç›®æ ¹ç›®å½• |
| `-out-dir` | `./output` | ç»“æœè¾“å‡ºç›®å½• |
| `-format` | `jsonl` | è¾“å‡ºæ ¼å¼ï¼š`jsonl` (æ•°æ®æŒ–æ˜ç”¨) æˆ– `mermaid` (å¯è§†åŒ–ç”¨) |
| `-jobs` | `4` | å¹¶å‘è§£æçš„å·¥ä½œçº¿ç¨‹æ•° |
| `-filter` | `""` | æ–‡ä»¶è¿‡æ»¤æ­£åˆ™è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼‰ |

---

## ğŸ—ºï¸ è·¯çº¿å›¾ (Roadmap)

æœ¬é¡¹ç›®é‡‡ç”¨åˆ†é˜¶æ®µæ¼”è¿›ç­–ç•¥ï¼Œæ—¨åœ¨ä»å½“å‰çš„ Java æ·±åº¦æ”¯æŒæ‰©å±•ä¸ºå…¨è¯­è¨€çš„ä»£ç åˆ†æå¼•æ“ã€‚

### 1. æ ¸å¿ƒå¼•æ“è·¯æ ‡ (Core Engine)

* [x] **æ’ä»¶åŒ–æ¶æ„è®¾è®¡**: å®ç°åŸºäº `Collector`, `Extractor`, `SymbolResolver` çš„å¤šè¯­è¨€æ‰©å±•æ¥å£ã€‚
* [x] **ä¸‰é˜¶æ®µå¤„ç†æµæ°´çº¿**: å®Œæˆâ€œç¬¦å·æ”¶é›† -> å±‚æ¬¡è¡¥å…¨ -> å…³ç³»æå–â€çš„é«˜æ•ˆå¤„ç†æµç¨‹ã€‚
* [x] **å¹¶å‘æ‰«æå¼•æ“**: æ”¯æŒåŸºäº `Worker Pool` çš„å¤šæ ¸å¹¶å‘è§£æï¼Œæ˜¾è‘—æå‡å¤„ç†é€Ÿåº¦ã€‚
* [x] **å¤šæ ¼å¼å¯¼å‡ºå™¨**: å·²æ”¯æŒ `JSONL` åŸç”Ÿæ•°æ®ä¸ `Mermaid` å¯è§†åŒ– HTML å¯¼å‡ºã€‚
* [ ] **æ€§èƒ½ç›‘æ§ä¸ç¼“å­˜**: å¼•å…¥ç¬¦å·è§£æ LRU ç¼“å­˜ï¼Œå¹¶é’ˆå¯¹ä¸‡çº§æ–‡ä»¶è§„æ¨¡è¿›è¡Œé”ç²’åº¦ä¼˜åŒ–ã€‚

### 2. Java è¯­è¨€è·¯æ ‡ (Java Extension)

* [x] **åŸºç¡€å®šä¹‰æ”¶é›†**: å®Œæˆç±»ã€æ¥å£ã€æšä¸¾ã€æ–¹æ³•ã€å­—æ®µåŠå…¶ Modifiers/Annotations çš„æå–ã€‚
* [x] **å¤æ‚ç¬¦å·è§£æ**: å®ç°åŸºäºåŒåŒ…æŸ¥æ‰¾ã€ç²¾ç¡®å¯¼å…¥åŠ `.*` é€šé…ç¬¦å¯¼å…¥çš„ç¬¦å·æ¶ˆæ­§ç®—æ³•ã€‚
* [x] **Java 17+ Record æ”¯æŒ**: æ·±åº¦é€‚é… Record è¯­æ³•ï¼Œè‡ªåŠ¨å…³è”éšå¼è®¿é—®å™¨ã€‚
* [x] **å†…ç½®ç¬¦å·è¡¨**: å·²é›†æˆ `java.lang` å¸¸ç”¨ç±»åŠæ ¸å¿ƒ API çš„å†…ç½®ç´¢å¼•ã€‚
* [ ] **é“¾å¼è°ƒç”¨ç±»å‹æ¨å¯¼**: è§£å†³ `a.getB().getC()` å½¢å¼çš„è°ƒç”¨è¿½è¸ªï¼Œæå‡ CALL å…³ç³»çš„è§£æç²¾åº¦ã€‚
* [ ] **åŒ¿åå— QN ç”Ÿæˆ**: ä¸º Lambda è¡¨è¾¾å¼ä¸åŒ¿åå†…éƒ¨ç±»åˆ†é…å”¯ä¸€ QNï¼Œè¡¥å…¨å‡½æ•°å¼ç¼–ç¨‹ä¾èµ–ã€‚

### 3. å¤šè¯­è¨€æ¨ªå‘æ‰©å±• (Language Expansion)

* [ ] **ğŸ¹ Go è¯­è¨€æ”¯æŒ** (è¿›è¡Œä¸­):
* [x] åŸºç¡€è¯­æ³•å®šä¹‰æ”¶é›†ã€‚
* [ ] é€‚é…â€œåŒç›®å½•å³åŒåŒ…â€çš„ç¬¦å·å¯è§æ€§é€»è¾‘ã€‚
* [ ] ç»“æ„ä½“åµŒå…¥ï¼ˆEmbeddingï¼‰ä¸æ¥å£éšå¼å®ç°è§£æã€‚


* [ ] **ğŸ Python æ”¯æŒ** (è§„åˆ’ä¸­): å¤„ç†ç›¸å¯¹è·¯å¾„å¯¼å…¥åŠè½»é‡çº§å¯å‘å¼ç±»å‹æ¨å¯¼ã€‚
* [ ] **ğŸ•¸ï¸ JavaScript/TypeScript** (è§„åˆ’ä¸­): åŸºäº ESM/CommonJS æ¨¡å—ç³»ç»Ÿçš„å…³ç³»æå–ã€‚

---

## ğŸ¤ å¼€æºè´¡çŒ®ï¼šå¦‚ä½•å¿«é€Ÿå¼€å‘æ–°è¯­è¨€æ’ä»¶ï¼Ÿ

æœ¬é¡¹ç›®é€šè¿‡ `x/` ç›®å½•å®ç°æ’ä»¶åŒ–ã€‚è‹¥è¦å¢åŠ å¯¹ **Go, Python, C++** ç­‰è¯­è¨€çš„æ”¯æŒï¼Œä»…éœ€å››æ­¥ï¼š

1. **å®šä¹‰ Language**: åœ¨ `model/language.go` ä¸­å¢åŠ è¯­è¨€æ ‡è¯†ã€‚
2. **å®ç° Collector**: å®šä¹‰å¦‚ä½•ä»è¯¥è¯­è¨€çš„ AST ä¸­è¯†åˆ«â€œå®šä¹‰â€ï¼ˆå®šä¹‰æ”¶é›†é€»è¾‘ï¼‰ã€‚
3. **å®ç° Extractor**: ç¼–å†™ Tree-sitter Query å®šä¹‰å¦‚ä½•æ•è·åŠ¨ä½œå‹ä¾èµ–ï¼ˆå¦‚ Call, Createï¼‰ã€‚
4. **å®ç° SymbolResolver**: å®šä¹‰è¯¥è¯­è¨€çš„ä½œç”¨åŸŸè§„åˆ™ï¼ˆå¦‚ Go çš„é¦–å­—æ¯å¯è§æ€§ï¼‰ã€‚
5. **æ³¨å†Œæ’ä»¶**: åœ¨æ–°åŒ…çš„ `init()` ä¸­æ³¨å†Œä¸Šè¿°å®ç°ã€‚

> **æç¤º**ï¼šå¯åˆ©ç”¨ `/parser` æä¾›çš„ `formatSExpression` å·¥å…·å°†ç›®æ ‡è¯­è¨€ AST å¯¼å‡ºï¼Œè¾…åŠ©ç¼–å†™ Queryã€‚

---

## ğŸ“œ License

æœ¬é¡¹ç›®åŸºäº [MIT License](https://www.google.com/search?q=LICENSE) åè®®å¼€æºã€‚